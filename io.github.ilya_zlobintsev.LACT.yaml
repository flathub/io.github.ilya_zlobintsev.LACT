app-id: io.github.ilya_zlobintsev.LACT
runtime: org.gnome.Platform
runtime-version: '48'
sdk: org.gnome.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
  - org.freedesktop.Sdk.Extension.llvm20
command: startup.sh
finish-args:
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  - --device=dri
  - --talk-name=org.freedesktop.Flatpak
  - --filesystem=/run/lactd.sock
cleanup:
  - /include
  - /share/vulkan/registry
  - '*.a'
  - /lib/pkgconfig
modules:
  - name: lact
    buildsystem: simple
    sources:
      # TODO: switch back to archive after next release
      #- type: archive
      #  url: https://github.com/ilya-zlobintsev/LACT/archive/refs/tags/v0.7.3.tar.gz
      #  sha256: 212ac1eadcbc8d7112b7ee11176c6ab0aee04f53bda9cfb342679c2e1cf6a230
      #  x-checker-data:
      #    type: anitya
      #    project-id: 372202
      #    url-template: https://github.com/ilya-zlobintsev/LACT/archive/refs/tags/v$version.tar.gz
      - type: git
        url: https://github.com/ilya-zlobintsev/LACT
        commit: 21eee8425aedb33be1180e4705c8ab7e12e924c0
      - generated-sources.json
    build-options:
      append-path: /usr/lib/sdk/rust-stable/bin:/usr/lib/sdk/llvm20/bin
      prepend-ld-library-path: /usr/lib/sdk/llvm20/lib
      env:
        CARGO_HOME: /run/build/lact/cargo
        PREFIX: /app
    build-commands:
      - cargo --offline fetch --manifest-path Cargo.toml
      - cargo --offline build -p lact --features flatpak --release
      - make install
      - install -Dm755 flatpak/startup.sh /app/bin/startup.sh
      - desktop-file-edit --set-key Exec --set-value startup.sh /app/share/applications/io.github.ilya_zlobintsev.LACT.desktop
    modules:
      - name: yad
        config-opts:
          - --enable-standalone
          - --disable-icon-browser
          - --disable-tools
        sources:
          - type: archive
            url: https://github.com/v1cont/yad/releases/download/v14.1/yad-14.1.tar.xz
            sha256: dde047a915cd8d3892c32b6ba031876f5cda673e01882c99613f043867c88133
            x-checker-data:
              type: anitya
              project-id: 5280
              url-template: https://github.com/v1cont/yad/releases/download/v$version/yad-$version.tar.xz
        cleanup:
          - /share/icons
        modules:
          - shared-modules/intltool/intltool-0.51.json
      - name: libdrm
        buildsystem: meson
        builddir: true
        config-opts:
          - -Dtests=false
          - --libdir=/app/drm/lib
        sources:
          - type: archive
            url: https://gitlab.freedesktop.org/mesa/drm/-/archive/libdrm-2.4.124/drm-libdrm-2.4.124.tar.gz
            sha256: 49c077f3938147e7c321fe89255eb189c1be68f6ed0aa36e29d38e3db0e84e08
            x-checker-data:
              type: anitya
              project-id: 1596
              url-template: https://gitlab.freedesktop.org/mesa/drm/-/archive/libdrm-$version/drm-libdrm-$version.tar.gz

  - name: vulkan-tools
    buildsystem: cmake-ninja
    config-opts:
      - -DVULKAN_HEADERS_INSTALL_DIR=/app
      - -DCMAKE_BUILD_TYPE=Release
      - -DBUILD_CUBE=OFF
      - -DBUILD_ICD=OFF
      - -DBUILD_VULKANINFO=ON
    sources:
      - type: archive
        url: https://github.com/KhronosGroup/Vulkan-Tools/archive/v1.4.314/Vulkan-Tools-1.4.314.tar.gz
        sha256: 720f10e8e5a8a816e869ab120a094480ba64c5a025822e88c5766c7938a435e0
        x-checker-data:
          type: anitya
          project-id: 242111
          url-template: https://github.com/KhronosGroup/Vulkan-Tools/archive/v$version/Vulkan-Tools-$version.tar.gz
    modules:
      - name: volk
        buildsystem: cmake-ninja
        config-opts:
          - -DVOLK_INSTALL=ON
        sources:
          - type: archive
            url: https://github.com/zeux/volk/archive/vulkan-sdk-1.4.313.0.tar.gz
            sha256: d86bcf1aff499f41a3e445b55df5e393a5ce49b1bda689eb7335b0a0a54a3c0b
            x-checker-data:
              type: anitya
              project-id: 370476
              url-template: https://github.com/zeux/volk/archive/vulkan-sdk-$version.tar.gz
        modules:
          - name: vulkan-headers
            buildsystem: cmake-ninja
            sources:
              - type: archive
                url: https://github.com/KhronosGroup/Vulkan-Headers/archive/v1.4.314/Vulkan-Headers-v1.4.314.tar.gz
                sha256: da32bccb312ddbc69519ee248ea222723083441e9d59bde4381c76bde8ad9dba
                x-checker-data:
                  type: anitya
                  project-id: 88835
                  url-template: https://github.com/KhronosGroup/Vulkan-Headers/archive/v$version/Vulkan-Headers-v$version.tar.gz
